---
title: "Productivity Model Structures"
author: "J.R. Blaszczak, C.B. Yackulic, R.O. Hall, Jr."
output: html_document
---


Each model used to estimate productivity dynamics in rivers through time consists of three components: (1) a growth model component, (2) a disturbance model component, and (3) the stochastic version of the full model which accounts for process and observation error.

We selected a subset of three river metabolism time series from 356 rivers with daily estimates of metabolism generated using the streamMetabolizer package in R by the US Geological Survey Powell Center (Appling et al. 2018a,b). Daily metabolism estimates were generated using a hierarchical state-space inverse modeling approach with partial-pooling of piece-wise $K_{600}$ relationships with mean daily discharge ($Q$) to reduce issues of equifinality and uncertainty (Appling et al. 2018). Daily metabolism and gas exchange estimates were generated from sub-daily time series of dissolved oxygen (units: $mg$ $L^{-1}$), light (photosynthetic photon flux density (PPFD); units: $\mu mol$ $m^{-2}$ $s^{-1}$), water temperature ($^\circ$ C), and reach averaged depth (m). A Bayesian Markov chain Monte Carlo (MCMC) fitting procedure was used to determine the mean and standard deviation of the posterior probability distributions of daily gross primary productivity (GPP; $g$ $O_{2}$ $m^{-2}$ $d^{-1}$),  ecosystem respiration (ER; $g$ $O_{2}$ $m^{-2}$ $d^{-1}$), and gas exchange ($K_{600}$; $d^{-1}$). In this study, we treat the mean and standard deviation of the daily GPP estimates from each river as "data" in the state-space models described below.


### Growth models
<div style="margin-bottom:20px;">
</div>
#### 1. Linear growth
We first predict the temporal dynamics of daily estimates of GPP ($G_{mod}$) using a linear model without latent biomass dynamics. We fit the model to the $G_{mod}$ times series from Appling et al. (2018) to estimate the model parameters:

\begin{equation} 
G_{pred,t} = \phi G_{pred,(t-\triangle t)} + \alpha L_{t}
\end{equation}

\begin{equation} 
G_{mod,t} = e^{(G_{pred, t})}
\end{equation}

where input data includes previously modeled mean daily GPP time series ($GPP_{mod,t}$; g $O_2$ $m^{-2}$ $d^{-1}$) and $L$ which is daily light at time $t$ relativized to the annual maximum daily light (unitless; 0<$L$<1). Estimated parameters include $G_{pred,t}$ which is the predicted daily GPP (g $O_2$ $m^{-2}$ $d^{-1}$) at time $t$ (in days) on a natural log scale, $\phi$ which is the estimated autoregressive parameter (unitless; 0<$\phi$<1), and $\alpha$ which is a light growth efficiency parameter (units: g $O_2$ $m^{-2}$ $d^{-1}$). 

<div style="margin-bottom:20px;">
</div>
#### 2. Latent biomass logistic growth
Next, we predict the temporal dyanmics of daily estimates of GPP ($G_{mod}$) by incorporating biomass as a latent variable and modeling its dynamics using a logistic growth model. We fit the model to the $G_{mod}$ times series from Appling et al. (2018) to estimate the model parameters:

\begin{equation}
    B_{t} = B_{(t-\triangle t)} e^{r_{max}B_{(t-\triangle t)}(1-\frac{B_{(t-\triangle t)}}{K})}
\end{equation}

\begin{equation}
    G_{mod,t} = \alpha L_{t} e^{B_{t}}
\end{equation}

input data includes previously modeled mean daily GPP time series ($GPP_{mod,t}$; g $O_2$ $m^{-2}$ $d^{-1}$) and $L$ which is daily light at time $t$ relativized to the annual maximum daily light (unitless; 0<$L$<1). Estimated parameters include $B_{t}$ which is a latent variable representative of photosynthetically-active biomass on a natural log scale and daily time step, $K$ which is the estimated carrying capacity of a river, $r_{max}$ is the maximum per capita growth rate when $\frac {B_t}{K}$ approaches zero following a disturbance, and $\alpha$ which is a light growth efficiency parameter (units: g $O_2$ $m^{-2}$ $d^{-1}$).

<div style="margin-bottom:20px;">
</div>
#### 3. Latent biomass thin film growth (density independent growth, density dependent death)
Finally, we predict the temporal dyanmics of daily estimates of GPP ($G_{mod}$) by incorporating biomass as a latent variable and modeling its dynamics using a modified logistic growth model with density independent growth rates and density dependent death rates. We fit the model to the $G_{mod}$ times series from Appling et al. (2018) to estimate the model parameters:








### Disturbance model

We lack sufficient geomorphic information to estimate the critical discharge of stream bed disturbance for each river in this study and expect to lack the necessary data as well for future analyses in more broadly spatially distributed rivers. The discharge threshold at which benthic autorophic biomass is removed can be different than that needed to move the bed. Therefore, we incorporate the effects of disturbance by modeling the persistence ($P$) of biomass using a complementary log-log link function of the form:
\begin{equation}
    P_{t} = e^{-e^{bQ*(Q_{t} - critQ)}}
\end{equation}

where $bQ$ is a parameter that characterizes the steepness of the persistence transition, $critQ$ is an estimated parameter which approximates the critical discharge at which autotrophic biomass is disturbed, and $Q$ is the standardized discharge time series. The log-log link function constrains values between 0 and 1, where 0 is no persistence and 1 is complete persistence.

We substituted different models of biomass growth within a model framework which accounts for the day-to-day persistence of biomass to loss from flow (i.e. sloughing, autogenic detachment, storm losses) and which accounts for refuge biomass, or the biomass remaining after a storm ($\beta_r$):

\begin{equation}
B_t = P_t (f(B_{t-1}, K, r_{max})-\beta_r) + \beta_r
\end{equation}

where $B_{t}$ is a form of latent biomass dependent on the form of the growth model, $P_{t}$ is the estimated persistence on that day based on equation 1, and $\beta_r$ is an estimated parameter of the refuge latent biomass following a disturbance. When $P_{t}$ is approximately 1, $\beta_r$ cancel each other out, but as $P_{t}$ is or approximates 0, the biomass contributing to the GPP signal for that day is equivalent to $\beta_r$.

Now expand to the full model:

\begin{equation}
B_t = P_t (B_{t-1} + r_{max}B_{t-1}(1-\frac{B_{t-1}}{K})-\beta_r) + \beta_r
\end{equation}


### Stochastic model
We fit the stochastic version of full model which accounts for process and observation error. For each model, we fit latent biomass ($B_{t}$) to daily GPP estimates which we treat as "observed data". We set the observation error ($\sigma_{G}$) to the standard deviation of the posterior probability distribution of the GPP estimates from the original streamMetabolizer output. We multiply $B_t$ by the daily light data (photosynthetic photon flux density (PPFD)) relativized to the annual maximum 0 and 1 ($L_t$) to account for instantaneous responses of autotrophic biomass photosynthesic rates to daily changes in light. Process error ($\sigma_{p}$), $r_{max}$, $\beta_r$, and $K$ have weakly informative priors based on a truncated (half) normal distribution:

\begin{equation}
B_{t} \sim N(P_{t}(B_{t-1} + r_{max}B_{t-1}(1-\frac{B_{t-1}}{K})-\beta_r) + \beta_{r},\sigma_{p})
\end{equation}

\begin{equation}
G_{t} \sim (L_{t} B_{t}, \sigma_{G})
\end{equation}

\begin{equation}
\sigma_{p} \sim N(> 0, 0, 2)
\end{equation}

\begin{equation}
r_{max} \sim N(> 0, 0, 15)
\end{equation}

\begin{equation}
K \sim N(> 0, 0, 30)
\end{equation}

\begin{equation}
\beta_r \sim N(> 0, 0, 10)
\end{equation}



Notes: When $\alpha$ was included in the model and multiplied by $L_{t}B_t$ as a light use efficiency parameter there seemed to be an interaction between $\alpha$ and $K$ which caused issues with chain convergence

